# ===================================================
# mounts
# ===================================================
mount=mount-cplusplus-service-source:
  bind: service
  path: /source
  read-only: true

mount=mount-cplusplus-service-build-x86_64:
  bind: build/cplusplus-service-x86_64
  path: /build

mount=mount-cplusplus-service-build-x86_64-dev:
  bind: build/cplusplus-service-x86_64-dev
  path: /build

mount=mount-cplusplus-service-install-x86_64:
  bind: gen/cplusplus-service-x86_64
  path: /install

mount=mount-cplusplus-service-install-x86_64-dev:
  bind: gen/cplusplus-service-x86_64-dev
  path: /install

mount=mount-cplusplus-service-build-aarch64:
  bind: build/cplusplus-service-aarch64
  path: /build

mount=mount-cplusplus-service-build-aarch64-dev:
  bind: build/cplusplus-service-aarch64-dev
  path: /build

mount=mount-cplusplus-service-install-aarch64:
  bind: gen/cplusplus-service-aarch64
  path: /install

mount=mount-cplusplus-service-install-aarch64-dev:
  bind: gen/cplusplus-service-aarch64-dev
  path: /install

mount=mount-cplusplus-service-version:
  bind: gen/gitversion/cpp/elbb
  path: /usr/local/include/elbb

# ===================================================
# images
# ===================================================
image=image-cplusplus-service-x86_64:
  image: "{env.BB_DOCKER_NAMESPACE:elbb}/bb-cplusplus-service-x86_64"
  depends:
   - cplusplus-service-build-x86_64
   - image-cplusplus-runtime-x86_64
  context: .
  dockerfile: service/Dockerfile.dobi
  tags: ["{env.GitVersion_BranchVersion}"]
  args:
    BB_DOCKER_NAMESPACE: "{env.BB_DOCKER_NAMESPACE:elbb}"
    RUNTIME_ARCH: "x86_64"
    RUNTIME_TAG: "{env.GitVersion_BranchVersion}"

image=image-cplusplus-service-x86_64-dev:
  image: "{env.BB_DOCKER_NAMESPACE:elbb}/bb-cplusplus-service-x86_64-dev"
  depends:
  depends:
   - cplusplus-service-build-x86_64-dev
   - image-cplusplus-runtime-x86_64-dev
  context: .
  dockerfile: service/Dockerfile.dobi
  tags: ["{env.GitVersion_BranchVersion}"]
  args:
    BB_DOCKER_NAMESPACE: "{env.BB_DOCKER_NAMESPACE:elbb}"
    RUNTIME_ARCH: "x86_64"
    RUNTIME_TAG: "{env.GitVersion_BranchVersion}"
    DEV: "1"

image=image-cplusplus-service-aarch64:
  image: "{env.BB_DOCKER_NAMESPACE:elbb}/bb-cplusplus-service-aarch64"
  depends:
   - cplusplus-service-build-aarch64
   - image-cplusplus-runtime-aarch64
  context: .
  dockerfile: service/Dockerfile.dobi
  tags: ["{env.GitVersion_BranchVersion}"]
  args:
    BB_DOCKER_NAMESPACE: "{env.BB_DOCKER_NAMESPACE:elbb}"
    RUNTIME_ARCH: "aarch64"
    RUNTIME_TAG: "{env.GitVersion_BranchVersion}"

image=image-cplusplus-service-aarch64-dev:
  image: "{env.BB_DOCKER_NAMESPACE:elbb}/bb-cplusplus-service-aarch64-dev"
  depends:
   - cplusplus-service-build-aarch64-dev
   - image-cplusplus-runtime-aarch64-dev
  context: .
  dockerfile: service/Dockerfile.dobi
  tags: ["{env.GitVersion_BranchVersion}"]
  args:
    BB_DOCKER_NAMESPACE: "{env.BB_DOCKER_NAMESPACE:elbb}"
    RUNTIME_ARCH: "aarch64"
    RUNTIME_TAG: "{env.GitVersion_BranchVersion}"
    DEV: "1"

# ===================================================
# images
# ===================================================

image=image-codechecker:
  image: codechecker
  context: codechecker
  tags: ["{env.GitVersion_BranchVersion}"]


# ===================================================
# jobs
# ===================================================
job=cplusplus-service-build-x86_64:
  use: image-cplusplus-builder
  mounts:
    - mount-cplusplus-service-source
    - mount-cplusplus-service-build-x86_64
    - mount-cplusplus-service-install-x86_64
    - mount-cplusplus-service-version
  command: sh -c '
    cd /build
    && conan install /source --build missing
    && cmake /source -DCMAKE_INSTALL_PREFIX=/install -DCMAKE_BUILD_TYPE=Release
    && make ${COMPONENT}
    && strip cplusplus_service
    && make install'
  sources:
    - service
  artifact:
    - gen/cplusplus-service-x86_64/cplusplus_service
  env:
    - "LOCAL_USER_ID={user.uid}"
    - "COMPONENT={env.COMPONENT:all}"
    - "VERBOSE={env.VERBOSE:}"
  annotations:
    description: "-> build clpusplus-service"

job=cplusplus-service-build-x86_64-dev:
  use: image-cplusplus-builder
  mounts:
    - mount-cplusplus-service-source
    - mount-cplusplus-service-build-x86_64-dev
    - mount-cplusplus-service-install-x86_64-dev
    - mount-cplusplus-service-version
  command: sh -c '
    cd /build
    && conan install /source --build missing
    && cmake /source -DCMAKE_INSTALL_PREFIX=/install -DCMAKE_BUILD_TYPE=Debug
    && make ${COMPONENT}
    && make install'
  sources:
    - service
  artifact:
    - gen/cplusplus-service-x86_64-dev/cplusplus_service
  env:
    - "LOCAL_USER_ID={user.uid}"
    - "COMPONENT={env.COMPONENT:all}"
    - "VERBOSE={env.VERBOSE:}"
  annotations:
    description: "-> build clpusplus-service"

job=cplusplus-service-build-aarch64:
  use: image-cplusplus-builder
  mounts:
    - mount-cplusplus-service-source
    - mount-cplusplus-service-build-aarch64
    - mount-cplusplus-service-install-aarch64
    - mount-cplusplus-service-version
  command: sh -c '
    cd /build
    && conan install /source --profile=/conan.armv8.profile --build missing
    && cmake /source -DCMAKE_CXX_COMPILER=/usr/bin/aarch64-linux-gnu-g++ -DCMAKE_INSTALL_PREFIX=/install -DCMAKE_BUILD_TYPE=Release
    && make ${COMPONENT}
    && aarch64-linux-gnu-strip cplusplus_service
    && make install'
  sources:
    - service
  artifact:
    - gen/cplusplus-service-aarch64/cplusplus_service
  env:
    - "LOCAL_USER_ID={user.uid}"
    - "COMPONENT={env.COMPONENT:all}"
    - "VERBOSE={env.VERBOSE:}"
  annotations:
    description: "-> build clpusplus-service"

job=cplusplus-service-build-aarch64-dev:
  use: image-cplusplus-builder
  mounts:
    - mount-cplusplus-service-source
    - mount-cplusplus-service-build-aarch64-dev
    - mount-cplusplus-service-install-aarch64-dev
    - mount-cplusplus-service-version
  command: sh -c '
    cd /build
    && conan install /source --profile=/conan.armv8.profile --build missing
    && cmake /source -DCMAKE_CXX_COMPILER=/usr/bin/aarch64-linux-gnu-g++ -DCMAKE_INSTALL_PREFIX=/install -DCMAKE_BUILD_TYPE=Debug
    && make ${COMPONENT}
    && make install'
  sources:
    - service
  artifact:
    - gen/cplusplus-service-aarch64-dev/cplusplus_service
  env:
    - "LOCAL_USER_ID={user.uid}"
    - "COMPONENT={env.COMPONENT:all}"
    - "VERBOSE={env.VERBOSE:}"
  annotations:
    description: "-> build clpusplus-service"

job=cplusplus-service-analyze:
  use: image-codechecker
  depends: [image-codechecker, image-cplusplus-service-x86_64]
  mounts:
    - mount-cplusplus-service-source
    - mount-cplusplus-service-build-x86_64
    - mount-cplusplus-service-install-x86_64
    - mount-cplusplus-service-version
  # Connect the container to the `dev environment` network
  net-mode: 'elbb-dev'
  command: sh -c 'if [ -z "${CODECHECKER_URL}" ]; then CODECHECKER_URL="http://codechecker-web:8001/Default"; fi; echo ${CODECHECKER_URL}; cd /build && CodeChecker analyze compile_commands.json -o reports/ &&
                               CodeChecker store reports/ --name "${PROJECT}" --url ${CODECHECKER_URL}'
  sources:
    - service
  artifact:
    - gen/cplusplus-service
  env:
    - "LOCAL_USER_ID={user.uid}"
    - "PROJECT={project}"
    - "CODECHECKER_URL={env.CODECHECKER_URL:}"
  annotations:
    description: "-> analyze clpusplus-service"

# ===================================================
# alias
# ===================================================
alias=cplusplus-service-build:
  tasks:
    - image-cplusplus-service-x86_64
    - image-cplusplus-service-x86_64-dev
    - image-cplusplus-service-aarch64
    - image-cplusplus-service-aarch64-dev

# ===================================================
# mounts
# ===================================================
mount=mount-source:
  bind: example/cplusplus/source
  path: /source
  read-only: true

mount=mount-build:
  bind: example/cplusplus/build
  path: /build

mount=mount-install:
  bind: example/cplusplus/install
  path: /install

mount=mount-gen:
  bind: gen/gitversion
  path: /gen

# ===================================================
# images
# ===================================================
image=image-elbb-cplusplus-builder:
  image: elbb/bb-cplusplus-builder
  tags: [0.1.0-71]
  pull: once

image=image-elbb-cplusplus-runtime:
  image: elbb/bb-cplusplus-runtime
  tags: [0.1.0-71]
  pull: once

# ===================================================
# jobs
# ===================================================
job=build-hello-world:
  use: image-elbb-cplusplus-builder
  mounts:
    - mount-source
    - mount-build
    - mount-install
    - mount-gen
  command: sh -c 'cd /build && cmake ${SRC_DIR} -DCMAKE_INSTALL_PREFIX=${INSTALL_DIR} && make ${COMPONENT} && make install'
  sources:
    - example/cplusplus/source
  artifact:
    - example/cplusplus/install/hello_world
  env:
    - "LOCAL_USER_ID={user.uid}"
    - "COMPONENT={env.COMPONENT:all}"
    - "ELBB_HEADER_PATH=/gen/cpp/"
  annotations:
    description: "-> build hello-world"

job=test-hello-world:
  use: image-elbb-cplusplus-runtime
  depends:
    - build-hello-world
  mounts:
    - mount-install
  command: sh -c '/install/hello_world'
  env:
    - "LOCAL_USER_ID={user.uid}"
  annotations:
    description: "-> run hello-world"

# ===================================================
# alias
# ===================================================

alias=cplusplus-test:
  tasks:
    - test-hello-world
